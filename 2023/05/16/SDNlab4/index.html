<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SDNlab4 | 悠然小筑</title><meta name="author" content="秦翌博"><meta name="copyright" content="秦翌博"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="XJTU软件定义网络课程的实验记录（报告）">
<meta property="og:type" content="article">
<meta property="og:title" content="SDNlab4">
<meta property="og:url" content="https://www.qin-dwt.com/2023/05/16/SDNlab4/index.html">
<meta property="og:site_name" content="悠然小筑">
<meta property="og:description" content="XJTU软件定义网络课程的实验记录（报告）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-16T11:17:14.000Z">
<meta property="article:modified_time" content="2023-05-16T11:20:26.899Z">
<meta property="article:author" content="秦翌博">
<meta property="article:tag" content="网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="https://www.qin-dwt.com/2023/05/16/SDNlab4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SDNlab4',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-16 19:20:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = 'hidden';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}

preloader.initLoading()
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="悠然小筑"><span class="site-name">悠然小筑</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SDNlab4</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-16T11:17:14.000Z" title="发表于 2023-05-16 19:17:14">2023-05-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-16T11:20:26.899Z" title="更新于 2023-05-16 19:20:26">2023-05-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%BD%A0%E7%9A%84%E5%B0%B1%E5%AE%8C%E4%BA%8B%E5%84%BF%E4%BA%86/">学你的就完事儿了</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SDNlab4"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="sdn实验四实验报告">SDN实验四实验报告</h1>
<h2 id="基础实验部分">基础实验部分</h2>
<p>在实际网络中，由于人为因素添加或删除流表常常出错，Veriflow的大致思想就是在下发流表前对其进行检验，并予以反馈，这样错误的规则被提前找到后就可避免其下发造成网络故障。</p>
<p>其原理主要依赖两个思想：</p>
<ul>
<li><p>对数据包划分等价类</p></li>
<li><p>使用增量算法减少计算量</p></li>
</ul>
<p>等价类：虽然网络中数据包的种类有很多，但若对于两个不同的数据包，其在所有交换机上的转发行为都相同，那幺就可将其视为同一类，这样网络中不同数据包的数量暂时就不会太多。具体维护用的<code>Trie</code>树。</p>
<p>增量算法：每次增加或者删除规则时，并不会有太多等价类受影响，于是只要处理受影响的那些等价类即可。</p>
<p>实验源码的思路，每增删一条规则：</p>
<ul>
<li><p>先根据要验证的规则计算受影响的数据包；</p></li>
<li><p>再根据网络中已有的<code>rule</code>划分等价类；</p></li>
<li><p>对每个等价类选取可能影响这个等价类的<code>rule</code>生成转发图；</p></li>
<li><p>遍历转发图以进行对规则的检验。</p></li>
</ul>
<p><img src="/2023/05/16/SDNlab4/1.png"></p>
<h3 id="输出每次影响ec的数量">输出每次影响EC的数量</h3>
<p><code>VeriFlow::verifyRule()</code>为执行VeriFlow核心算法的函数，包括对等价类的划分、转发图的构造与不变量的验证
。函数中变量<code>ecCount</code>为EC数目。仅需要将<code>ecCount</code>打印输出到日志文件即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">fprintf</span>(stdout, <span class="string">"\n"</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(stdout, <span class="string">"[VeriFlow::verifyRule] ecCount: %lu\n"</span>, ecCount);</span><br><span class="line">		<span class="built_in">fprintf</span>(fp, <span class="string">"[VeriFlow::verifyRule] ecCount: %lu\n"</span>, ecCount);</span><br><span class="line">	}</span><br></pre></td></tr></table></figure>
<p>重新编译，日志文件截图</p>
<p><img src="/2023/05/16/SDNlab4/image-20230504230454904.png"></p>
<p>第一次加入默认转发控制器的流表 ec=1。</p>
<p>然后加入lldp ec=5。</p>
<p><img src="/2023/05/16/SDNlab4/image-20230504222420069.png">最后ping之后按mac被划开了3个ec。</p>
<h3 id="打印出环路路径的信息">打印出环路路径的信息</h3>
<p><code>VeriFlow::traverseForwardingGraph()</code>为遍历某个特定EC的转发图，验证是否存在环路或黑洞。仅需要增加一个变量<code>vector&lt;string&gt;path</code>记录环路路径即可。(发现重复点不意味该路径上所有点都在环路上，要过滤掉之前的点)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">	<span class="built_in">fprintf</span>(fp, <span class="string">"[VeriFlow::traverseForwardingGraph_printLoop] found Loop:"</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(; i &lt; path.<span class="built_in">size</span>(); ++i) {</span><br><span class="line">			<span class="keyword">if</span> (path[i] == currentLocation) <span class="keyword">break</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">for</span>(; i &lt; path.<span class="built_in">size</span>(); ++i) {</span><br><span class="line">			<span class="built_in">fprintf</span>(fp, <span class="string">"%s --&gt; "</span>, path[i].<span class="built_in">c_str</span>());</span><br><span class="line">	}</span><br><span class="line">	<span class="built_in">fprintf</span>(fp, <span class="string">"%s\n"</span>,currentLocation.<span class="built_in">c_str</span>());</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; faults.<span class="built_in">size</span>(); i++) {</span><br><span class="line">		<span class="keyword">if</span> (packetClass.<span class="built_in">subsumes</span>(faults[i])) {s</span><br><span class="line">			faults.<span class="built_in">erase</span>(faults.<span class="built_in">begin</span>() + i);</span><br><span class="line">			i--;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	faults.<span class="built_in">push_back</span>(packetClass);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">visited.<span class="built_in">insert</span>(currentLocation);</span><br><span class="line">path.<span class="built_in">push_back</span>(currentLocation);</span><br></pre></td></tr></table></figure>
<p>重新编译，日志文件截图</p>
<p><img src="/2023/05/16/SDNlab4/image-20230504234426738.png"></p>
<h3 id="进一步打印出环路对应的ec的相关信息">进一步打印出环路对应的EC的相关信息</h3>
<p>简化EC信息的表示形式，仅从14个域中提取TCP/IP五元组作为主要信息显示</p>
<p>现有EC的基本信息打印代码在<code>VeriFlow::traverseForwardingGraph():</code>里</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(fp, <span class="string">"[VeriFlow::traverseForwardingGraph] PacketClass: %s\n"</span>, packetClass.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br></pre></td></tr></table></figure>
<p>仿照<code>EquivalenceClass::toString()</code>函数加入一个成员函数即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">EquivalenceClass::toString5</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">	<span class="built_in">sprintf</span>(buffer, <span class="string">"nw_src(%s-%s), nw_dst(%s-%s),nw_proto(%lu-%lu),tp_src(%lu-%lu),tp_dst(%lu-%lu)"</span>,</span><br><span class="line">			::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;lowerBound[NW_SRC]).<span class="built_in">c_str</span>(),</span><br><span class="line">			::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;upperBound[NW_SRC]).<span class="built_in">c_str</span>(),</span><br><span class="line">			::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;lowerBound[NW_DST]).<span class="built_in">c_str</span>(),</span><br><span class="line">			::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;upperBound[NW_DST]).<span class="built_in">c_str</span>(),</span><br><span class="line">			<span class="keyword">this</span>-&gt;lowerBound[NW_PROTO],</span><br><span class="line">			<span class="keyword">this</span>-&gt;upperBound[NW_PROTO],</span><br><span class="line">			<span class="keyword">this</span>-&gt;lowerBound[TP_SRC],</span><br><span class="line">			<span class="keyword">this</span>-&gt;upperBound[TP_SRC],</span><br><span class="line">			<span class="keyword">this</span>-&gt;lowerBound[TP_DST],</span><br><span class="line">			<span class="keyword">this</span>-&gt;upperBound[TP_DST]			</span><br><span class="line">			);</span><br><span class="line"></span><br><span class="line">	string retVal = buffer;</span><br><span class="line">	<span class="keyword">return</span> retVal;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(fp, <span class="string">"[VeriFlow::traverseForwardingGraph] PacketClass: %s\n"</span>, packetClass.<span class="built_in">toString5</span>().<span class="built_in">c_str</span>());</span><br></pre></td></tr></table></figure></p>
<p>重新编译，日志文件截图</p>
<p><img src="/2023/05/16/SDNlab4/image-20230504235220555.png"></p>
<h3 id="分析原始代码与补丁代码的区别思考为何需要添加补丁">分析原始代码与补丁代码的区别，思考为何需要添加补丁</h3>
<p><img src="/2023/05/16/SDNlab4/image-20230505102624854.png"></p>
<p><code>veriflow/VeriFlow/OpenFlowProtocolMessage.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>-&gt;location = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;nextHop = <span class="string">""</span>;</span><br><span class="line">-       <span class="keyword">this</span>-&gt;in_port = <span class="number">65536</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;priority = INVALID_PRIORITY;</span><br><span class="line">        <span class="comment">// this-&gt;outPort = OFPP_NONE;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-       rule.fieldValue[IN_PORT] = <span class="string">"0"</span>;<span class="comment">//::convertIntToString(ntohs(ofr-&gt;match.in_port));</span></span><br><span class="line">-       rule.fieldMask[IN_PORT] = <span class="string">"0"</span>;<span class="comment">//((rule.wildcards == OFPFW_ALL) || ((rule.wildcards &amp; OFPFW_IN_PORT) != 0)) ? "0" : "65535";</span></span><br><span class="line">-       rule.in_port = <span class="built_in">ntohs</span>(ofr-&gt;match.in_port);</span><br><span class="line">+       rule.fieldValue[IN_PORT] = ::<span class="built_in">convertIntToString</span>(<span class="built_in">ntohs</span>(ofr-&gt;match.in_port));</span><br><span class="line">+       rule.fieldMask[IN_PORT] = ((rule.wildcards == OFPFW_ALL) || ((rule.wildcards &amp; OFPFW_IN_PORT) != <span class="number">0</span>)) ? <span class="string">"0"</span> : <span class="string">"65535"</span>;</span><br></pre></td></tr></table></figure>
<p>原来只有与<code>rule</code>的<code>inport</code>相同的数据包才需要被验证，从这些数据包中划分等价类。打补丁后<code>field0</code>的值为<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.554ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4222.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(1333.7,0)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"/><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"/><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"/><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(1500,0)"/><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(2000,0)"/></g><g data-mml-node="mo" transform="translate(3833.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span>。建立<code>tries</code>树时忽略<code>inport</code>。等价类的划分和影响这些数据包转发的<code>rule</code>与<code>inport</code>无关。建立<code>ForwardingGraph</code>寻找<code>rule</code>时不会考虑<code>inport</code>。这样才能建立正确的转发图。</p>
<p>要理解为何如此处理首先得理解未打补丁前代码的逻辑：划分完等价类之后，会去寻找所有可能影响这些等价类的<code>rule</code>，只有<code>inport</code>与该等价类相等会被找到形成转发图，所以会产生黑洞。</p>
<p>一个例子：</p>
<p><img src="/2023/05/16/SDNlab4/image-20230505235330064.png"></p>
<p>但是<code>trie</code>树的叶子节点对于<code>inport</code>不同但其他匹配域相同的<code>rule</code>只会保留最先来的那一条。这个问题在下面解决了。</p>
<p>补丁修改了对于等号的重载：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span>((<span class="keyword">this</span>-&gt;type == other.type)</span><br><span class="line">                        &amp;&amp; (<span class="keyword">this</span>-&gt;wildcards == other.wildcards)</span><br><span class="line">                        &amp;&amp; (<span class="keyword">this</span>-&gt;location.<span class="built_in">compare</span>(other.location) == <span class="number">0</span>)</span><br><span class="line">-                       &amp;&amp; (<span class="keyword">this</span>-&gt;in_port == other.in_port)</span><br><span class="line">                        <span class="comment">// &amp;&amp; (this-&gt;nextHop.compare(other.nextHop) == 0) // Not present in OFPT_FLOW_REMOVED messages.</span></span><br><span class="line">                        &amp;&amp; (<span class="keyword">this</span>-&gt;priority == other.priority)</span><br><span class="line">                        <span class="comment">// &amp;&amp; (this-&gt;outPort == other.outPort) // Not used in this version.</span></span><br></pre></td></tr></table></figure>
<p>把<code>inport</code>不同的<code>rule</code>保存在<code>trie</code>树的同一个叶子节点上。</p>
<hr>
<p><code>veriflow/VeriFlow/VeriFlow.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; vGraph.<span class="built_in">size</span>(); i++)</span><br><span class="line">        {</span><br><span class="line">                unordered_set&lt; string &gt; visited;</span><br><span class="line">-               string lastHop = network.<span class="built_in">getNextHopIpAddress</span>(rule.location,rule.in_port);</span><br><span class="line">-               <span class="comment">// fprintf(fp, "start traversing at: %s\n", rule.location.c_str());</span></span><br><span class="line">-               <span class="keyword">if</span>(!<span class="keyword">this</span>-&gt;<span class="built_in">traverseForwardingGraph</span>(vFinalPacketClasses[i], vGraph[i], rule.location, lastHop, visited, fp)) {</span><br><span class="line">+               <span class="keyword">if</span>(!<span class="keyword">this</span>-&gt;<span class="built_in">traverseForwardingGraph</span>(vFinalPacketClasses[i], vGraph[i], rule.location, visited, fp)) {</span><br><span class="line">                        ++currentFailures;</span><br><span class="line">                }</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>
<p>所以需要在 <code>VeriFlow::traverseForwardingGraph()</code>
中加入上一跳的信息进行转发验证。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-       <span class="comment">// input_port as a filter</span></span><br><span class="line">-       <span class="keyword">if</span>(lastHop.<span class="built_in">compare</span>(<span class="string">"NULL"</span>) == <span class="number">0</span> || itr-&gt;rule.in_port == <span class="number">65536</span>){</span><br><span class="line">-               <span class="comment">// do nothing</span></span><br><span class="line">-       }</span><br><span class="line">-       <span class="keyword">else</span>{</span><br><span class="line">-               <span class="keyword">while</span>(itr != linkList.<span class="built_in">end</span>()){</span><br><span class="line">-                       string connected_hop = network.<span class="built_in">getNextHopIpAddress</span>(currentLocation, itr-&gt;rule.in_port);</span><br><span class="line">-                       <span class="keyword">if</span>(connected_hop.<span class="built_in">compare</span>(lastHop) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">-                       itr++;</span><br><span class="line">-               }</span><br><span class="line">-       }</span><br></pre></td></tr></table></figure>
<p>在这段代码中，通过比较上一跳是否相同，来找到正确的规则。（不比较可能有环路）</p>
<hr>
<p>这样的思路一旦被加入，则可能出现新的黑洞，匹配上该<code>in_port</code>的规则可能一条都没有。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-       <span class="keyword">if</span>(itr == linkList.<span class="built_in">end</span>()){</span><br><span class="line">-               <span class="comment">// Found a black hole.</span></span><br><span class="line">-               <span class="built_in">fprintf</span>(fp, <span class="string">"\n"</span>);</span><br><span class="line">-               <span class="built_in">fprintf</span>(fp, <span class="string">"[VeriFlow::traverseForwardingGraph] Found a BLACK HOLE for the following packet class as there is no outgoing link at current location (%s).\n"</span>, currentLocation.<span class="built_in">c_str</span>());</span><br><span class="line">-               <span class="built_in">fprintf</span>(fp, <span class="string">"[VeriFlow::traverseForwardingGraph] PacketClass: %s\n"</span>, packetClass.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">-               <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; faults.<span class="built_in">size</span>(); i++) {</span><br><span class="line">-                       <span class="keyword">if</span> (packetClass.<span class="built_in">subsumes</span>(faults[i])) {</span><br><span class="line">-                               faults.<span class="built_in">erase</span>(faults.<span class="built_in">begin</span>() + i);</span><br><span class="line">-                               i--;</span><br><span class="line">-                       }</span><br><span class="line">-               }</span><br><span class="line">-               faults.<span class="built_in">push_back</span>(packetClass);</span><br><span class="line">-</span><br><span class="line">-               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">-       }</span><br></pre></td></tr></table></figure>
<h2 id="拓展实验部分">拓展实验部分</h2>
<h3 id="规则的优先级字段">规则的优先级字段</h3>
<p>修改<code>waypoint_path.py</code>添加规则的优先级字段改为1，日志文件中发现不了环路。</p>
<p><img src="/2023/05/16/SDNlab4/image-20230505114652535.png"></p>
<hr>
<p>修改优先级后<code>s22</code>的流表项：</p>
<p><img src="/2023/05/16/SDNlab4/image-20230505115044664.png"></p>
<p>修改前：</p>
<p><img src="/2023/05/16/SDNlab4/image-20230505115142296.png"></p>
<p>可以观察到，在
OVS中，匹配字段相同的两个规则，若优先级也相同，新规则会覆盖掉旧的规则。事实上存在环路，但VeriFlow并没有检测出来环路。</p>
<p>原因：当出现规则完全匹配需要对原来的规则进行覆盖的时候， VeriFlow
保留了原来的规则并抛弃了新加的规则（并没有验证）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(command == OFPFC_ADD)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">// We may choose not to verify a rule if that rule is already present in the data plane.</span></span><br><span class="line">		<span class="type">bool</span> res = <span class="keyword">this</span>-&gt;<span class="built_in">addRule</span>(rule);</span><br><span class="line">		<span class="keyword">if</span>(res == <span class="literal">false</span>)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br></pre></td></tr></table></figure>
<p>在添加规则时，要首先检查这条规则是否已经存在，这主要是通过
<code>addRule</code>实现的：</p>
<p>在<code>VeriFlow::addRule</code>中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(leaf-&gt;ruleSet == <span class="literal">NULL</span>)</span><br><span class="line">			{</span><br><span class="line">				leaf-&gt;ruleSet = <span class="keyword">new</span> unordered_set&lt; Rule, KHash&lt; Rule &gt;, KEqual&lt; Rule &gt; &gt;;</span><br><span class="line">				<span class="keyword">if</span>(leaf-&gt;ruleSet == <span class="literal">NULL</span>)</span><br><span class="line">				{</span><br><span class="line">					<span class="built_in">fprintf</span>(stderr, <span class="string">"[VeriFlow::addRule] Memory allocation error (leaf-&gt;ruleSet == NULL). Terminating process.\n"</span>);</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			{</span><br><span class="line">				unordered_set&lt; Rule, KHash&lt; Rule &gt;, KEqual&lt; Rule &gt; &gt;::const_iterator itr;</span><br><span class="line">				itr = leaf-&gt;ruleSet-&gt;<span class="built_in">find</span>(rule);</span><br><span class="line">				<span class="keyword">if</span>(itr != leaf-&gt;ruleSet-&gt;<span class="built_in">end</span>()) <span class="comment">// Rule already exists.</span></span><br><span class="line">				{</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">				}</span><br><span class="line">			}</span><br></pre></td></tr></table></figure>
<p>在寻找<code>itr</code>中，在<code>ruleset</code>中寻找<code>rule</code>时，需要用到对等号的重载：</p>
<p>在<code>rule.h</code>中，等号被如此重载：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Rule::equals</span><span class="params">(<span class="type">const</span> Rule&amp; other)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ALL_FIELD_INDEX_END_MARKER; i++)</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">if</span>((<span class="keyword">this</span>-&gt;fieldValue[i].<span class="built_in">compare</span>(other.fieldValue[i]) != <span class="number">0</span>)</span><br><span class="line">				|| (<span class="keyword">this</span>-&gt;fieldMask[i].<span class="built_in">compare</span>(other.fieldMask[i]) != <span class="number">0</span>))</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>((<span class="keyword">this</span>-&gt;type == other.type)</span><br><span class="line">			&amp;&amp; (<span class="keyword">this</span>-&gt;wildcards == other.wildcards)</span><br><span class="line">			&amp;&amp; (<span class="keyword">this</span>-&gt;location.<span class="built_in">compare</span>(other.location) == <span class="number">0</span>)</span><br><span class="line">			&amp;&amp; (<span class="keyword">this</span>-&gt;in_port == other.in_port)</span><br><span class="line">			<span class="comment">// &amp;&amp; (this-&gt;nextHop.compare(other.nextHop) == 0) // Not present in OFPT_FLOW_REMOVED messages.</span></span><br><span class="line">			&amp;&amp; (<span class="keyword">this</span>-&gt;priority == other.priority)</span><br><span class="line">			<span class="comment">// &amp;&amp; (this-&gt;outPort == other.outPort) // Not used in this version.</span></span><br><span class="line">	)</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Rule::<span class="keyword">operator</span>==(<span class="type">const</span> Rule&amp; other) <span class="type">const</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">equals</span>(other);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>所以如果加入优先级相同，<code>inport</code>相同，其他也相同的规则时，就会<code>return false</code>。实际上新加的规则并没有加进去。</p>
<p><del>所以<code>waypoint_path.py</code>加了规则，但是又没加。</del></p>
<h3 id="挑选多个域不少于5个进行验证">挑选多个域（不少于5个）进行验证</h3>
<h4 id="实验网络拓扑">实验网络拓扑</h4>
<p>和基础实验部分一样</p>
<h4 id="所选匹配域">所选匹配域</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">FieldIndex</span></span><br><span class="line">{</span><br><span class="line">	IN_PORT, <span class="comment">// 0</span></span><br><span class="line">	DL_SRC,</span><br><span class="line">	DL_DST,</span><br><span class="line">	DL_TYPE,</span><br><span class="line">	DL_VLAN,</span><br><span class="line">	DL_VLAN_PCP,</span><br><span class="line">	MPLS_LABEL,</span><br><span class="line">	MPLS_TC,</span><br><span class="line">	NW_SRC,</span><br><span class="line">	NW_DST,</span><br><span class="line">	NW_PROTO,</span><br><span class="line">	NW_TOS,</span><br><span class="line">	TP_SRC,</span><br><span class="line">	TP_DST,</span><br><span class="line">	ALL_FIELD_INDEX_END_MARKER, <span class="comment">// 14</span></span><br><span class="line">	METADATA, <span class="comment">// 15, not used in this version.</span></span><br><span class="line">	WILDCARDS <span class="comment">// 16</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<ul>
<li>in_port=port，ovs上的port接口名，可以通过ovs-ofctl
show查看有哪些port</li>
<li>dl_vlan=vlan，匹配的vlan，范围是0-4095</li>
<li>dl_vlan_pcp=priority，匹配多个vlan时的优先级，范围0-7，值越大越优先</li>
<li>dl_src=xx:xx:xx:xx:xx:xx，匹配源mac地址</li>
<li>dl_dst=xx:xx:xx:xx:xx:xx，匹配目的mac</li>
<li>dl_type=ethertype，匹配协议类型，比如0x0806代表arp协议，0x0800代表ip协议</li>
<li>nw_src=ip[/netmask]，匹配源ip</li>
<li>nw_dst=ip[/netmask]，匹配目的ip</li>
<li>nw_proto=proto，匹配协议类型（十进制），范围0-255，比如1代表icmp，6代表tcp</li>
<li>nw_tos=68，IP 数据包的 ToS(Type of Service)
字段,代表提供的服务类型或服务等级</li>
<li>tp_src=port，匹配源port端口</li>
<li>tp_dst=port，匹配目的port端口</li>
</ul>
<p>考虑到验证的难度和可行性，选取这些域进行验证：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IN_PORT, </span><br><span class="line">DL_SRC,</span><br><span class="line">DL_DST,</span><br><span class="line">DL_TYPE,</span><br><span class="line">NW_SRC,</span><br><span class="line">NW_DST,</span><br></pre></td></tr></table></figure>
<h4 id="构造的规则及预期网络转发行为">构造的规则及预期网络转发行为</h4>
<p>构造的规则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">path = [(<span class="number">2</span>,<span class="number">23</span>,<span class="number">3</span>),(<span class="number">3</span>, <span class="number">12</span>, <span class="number">2</span>), (<span class="number">3</span>, <span class="number">18</span>, <span class="number">4</span>), (<span class="number">2</span>, <span class="number">19</span>, <span class="number">3</span>), (<span class="number">3</span>, <span class="number">20</span>, <span class="number">2</span>), (<span class="number">2</span>, <span class="number">13</span>, <span class="number">4</span>),(<span class="number">2</span>,<span class="number">15</span>,<span class="number">3</span>),(<span class="number">3</span>,<span class="number">22</span>,<span class="number">4</span>),(<span class="number">4</span>,<span class="number">23</span>,<span class="number">3</span>)]</span><br><span class="line">   ILLINOIS_mac = <span class="string">"00:00:00:00:00:01"</span></span><br><span class="line">   USC_mac = <span class="string">"00:00:00:00:00:02"</span></span><br><span class="line">   <span class="comment"># send flow mod</span></span><br><span class="line">   <span class="keyword">for</span> node <span class="keyword">in</span> path:</span><br><span class="line">       in_port, dpid, out_port = node</span><br><span class="line">       add_flow(dpid, <span class="string">'10.0.0.0/24'</span>, <span class="string">'10.0.0.0/24'</span>, in_port, out_port,USC_mac,ILLINOIS_mac)</span><br><span class="line">       add_flow(dpid, <span class="string">'10.0.0.0/24'</span>, <span class="string">'10.0.0.0/24'</span>, out_port, in_port,ILLINOIS_mac,USC_mac)</span><br></pre></td></tr></table></figure>
<p>预期的转发行为:</p>
<p>对网络并无影响，可以正常ping通。</p>
<h4 id="预期的veriflow验证结果">预期的VeriFlow验证结果</h4>
<p><img src="/2023/05/16/SDNlab4/image-20230506145205819.png"></p>
<p>veriflow会发现此黄色环路。</p>
<h4 id="veriflow的实际验证结果">VeriFlow的实际验证结果</h4>
<p><img src="/2023/05/16/SDNlab4/image-20230506145517161.png"></p>
<p>ec为1（并不会受其他ipv4，lldp（类型不同）的流表的影响而划分），相关信息也符合预期。</p>
<p>对这个ec会出现环路，但对实际网络的ping行为无影响（并不在这个等价类中）</p>
<p>环路路径也符合预期。</p>
<p>其余各域也与预期符合。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.qin-dwt.com">秦翌博</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.qin-dwt.com/2023/05/16/SDNlab4/">https://www.qin-dwt.com/2023/05/16/SDNlab4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.qin-dwt.com" target="_blank">悠然小筑</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/04/25/SDNlab3/" title="SDNlab3"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SDNlab3</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/25/SDNlab3/" title="SDNlab3"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-25</div><div class="title">SDNlab3</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">秦翌博</div><div class="author-info__description">其処に沿って進めばいい</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/deswinteil" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:786169233@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">博客刚刚草创，百废待兴</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sdn%E5%AE%9E%E9%AA%8C%E5%9B%9B%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A"><span class="toc-number">1.</span> <span class="toc-text">SDN实验四实验报告</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%AE%9E%E9%AA%8C%E9%83%A8%E5%88%86"><span class="toc-number">1.1.</span> <span class="toc-text">基础实验部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E6%AF%8F%E6%AC%A1%E5%BD%B1%E5%93%8Dec%E7%9A%84%E6%95%B0%E9%87%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">输出每次影响EC的数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E5%87%BA%E7%8E%AF%E8%B7%AF%E8%B7%AF%E5%BE%84%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">打印出环路路径的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%89%93%E5%8D%B0%E5%87%BA%E7%8E%AF%E8%B7%AF%E5%AF%B9%E5%BA%94%E7%9A%84ec%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.3.</span> <span class="toc-text">进一步打印出环路对应的EC的相关信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%8E%9F%E5%A7%8B%E4%BB%A3%E7%A0%81%E4%B8%8E%E8%A1%A5%E4%B8%81%E4%BB%A3%E7%A0%81%E7%9A%84%E5%8C%BA%E5%88%AB%E6%80%9D%E8%80%83%E4%B8%BA%E4%BD%95%E9%9C%80%E8%A6%81%E6%B7%BB%E5%8A%A0%E8%A1%A5%E4%B8%81"><span class="toc-number">1.1.4.</span> <span class="toc-text">分析原始代码与补丁代码的区别，思考为何需要添加补丁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E5%AE%9E%E9%AA%8C%E9%83%A8%E5%88%86"><span class="toc-number">1.2.</span> <span class="toc-text">拓展实验部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E5%AD%97%E6%AE%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">规则的优先级字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%91%E9%80%89%E5%A4%9A%E4%B8%AA%E5%9F%9F%E4%B8%8D%E5%B0%91%E4%BA%8E5%E4%B8%AA%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.2.</span> <span class="toc-text">挑选多个域（不少于5个）进行验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">实验网络拓扑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E9%80%89%E5%8C%B9%E9%85%8D%E5%9F%9F"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">所选匹配域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E7%9A%84%E8%A7%84%E5%88%99%E5%8F%8A%E9%A2%84%E6%9C%9F%E7%BD%91%E7%BB%9C%E8%BD%AC%E5%8F%91%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">构造的规则及预期网络转发行为</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E7%9A%84veriflow%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">预期的VeriFlow验证结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#veriflow%E7%9A%84%E5%AE%9E%E9%99%85%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">VeriFlow的实际验证结果</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/16/SDNlab4/" title="SDNlab4">SDNlab4</a><time datetime="2023-05-16T11:17:14.000Z" title="发表于 2023-05-16 19:17:14">2023-05-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/25/SDNlab3/" title="SDNlab3">SDNlab3</a><time datetime="2023-04-25T11:58:54.000Z" title="发表于 2023-04-25 19:58:54">2023-04-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/12/AI%E5%AF%BC%E8%AE%BA/" title="人工智能导论">人工智能导论</a><time datetime="2023-04-12T04:28:54.000Z" title="发表于 2023-04-12 12:28:54">2023-04-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By 秦翌博</div><div class="footer_custom_text">唯有将勤补拙，攻苦食淡，方能韦编三绝，磨杵成针。<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>